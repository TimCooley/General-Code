

---------------------------------FINDING ACCOUNTS THAT HAVE ALL CASE TRANSACTIONS EXCLUDED



--- FIND ACCOUNTS WHERE ALL CASE TRANSACTIONS ARE EXCLUDED

SELECT  CASE_ID, C.SHORT_NAME,  account_id, TOTAL_COUNT, EXCLUDED_COUNT
FROM (   
SELECT CASE_ID,CLIENT_ID,account_id, COUNT(1) AS total_count, SUM( CASE  WHEN exclude_reason IS NOT NULL THEN 1 ELSE 0 END) AS excluded_count 
FROM PREFILING.case_transaction 
--FROM FRT.case_transaction 
WHERE CASE_ID IN (&CASE_ID_VAR)
AND (FRT_TRANSACTION_TYPE IN ('B', 'S'))
GROUP BY CASE_ID,CLIENT_ID, account_Id
) CT, CLIENT C
WHERE  CT.CLIENT_ID = C.CLIENT_ID
AND total_count = excluded_count
AND ACCOUNT_ID IN (SELECT ACCOUNT_ID FROM ACCOUNT WHERE STATUS IN ('ACTIVE','APPROVAL'))
AND C.STATUS IN ('ACTIVE', 'APPROVAL')
ORDER BY C.SHORT_NAME
;


--- FIND ACCOUNTS WHERE ALL CASE TRANSACTIONS IN THE CLASS PERIOD ARE EXCLUDED

SELECT  CASE_ID, C.SHORT_NAME,  account_id, TOTAL_COUNT, EXCLUDED_COUNT
FROM (   
SELECT CASE_ID,CLIENT_ID,account_id, COUNT(1) AS total_count, SUM( 
CASE  
WHEN exclude_reason IS NOT NULL 
AND TRADE_DATE > (SELECT DISTINCT CLASS_PERIOD_START_DATE FROM CASE_DETAIL WHERE CASE_ID IN (&CASE_ID_VAR))
AND TRADE_DATE < (SELECT DISTINCT CLASS_PERIOD_END_DATE FROM CASE_DETAIL WHERE CASE_ID IN (&CASE_ID_VAR))
THEN 1 ELSE 0 END) AS excluded_count 
FROM prefiling.case_transaction 
--FROM FRT.case_transaction 
WHERE CASE_ID IN (&CASE_ID_VAR)
AND (FRT_TRANSACTION_TYPE IN ('B', 'S'))
GROUP BY CASE_ID,CLIENT_ID, account_Id
) CT, CLIENT C
WHERE  CT.CLIENT_ID = C.CLIENT_ID
AND total_count = excluded_count
AND ACCOUNT_ID IN (SELECT ACCOUNT_ID FROM ACCOUNT WHERE STATUS IN ('ACTIVE','APPROVAL'))
AND C.STATUS IN ('ACTIVE', 'APPROVAL')
ORDER BY C.SHORT_NAME
;





--- FIND ACCOUNTS WHERE ALL CASE TRANSACTIONS IN THE CLASS PERIOD ARE EXCLUDED. NOT INCLUDING "REASONABLE" EXCLUDE REASONS

SELECT  CASE_ID, C.SHORT_NAME,  account_id, TOTAL_COUNT, EXCLUDED_COUNT
FROM (   
SELECT CASE_ID,CLIENT_ID,account_id, COUNT(1) AS total_count, SUM( 
CASE  
WHEN exclude_reason IS NOT NULL 
AND TRADE_DATE > (SELECT DISTINCT CLASS_PERIOD_START_DATE FROM CASE_DETAIL WHERE CASE_ID IN (&CASE_ID_VAR))
AND TRADE_DATE < (SELECT DISTINCT CLASS_PERIOD_END_DATE FROM CASE_DETAIL WHERE CASE_ID IN (&CASE_ID_VAR))
AND EXCLUDE_REASON NOT LIKE ('IN AND%')
AND EXCLUDE_REASON NOT LIKE ('IN &%')
AND EXCLUDE_REASON NOT LIKE ('%INELIGIBLE INSTRUMENT%')
AND EXCLUDE_REASON NOT LIKE ('%INELIGIBLE%')
AND EXCLUDE_REASON NOT LIKE ('%SWAP%')
THEN 1 ELSE 0 END) AS excluded_count 
FROM prefiling.case_transaction 
--FROM FRT.case_transaction 
WHERE CASE_ID IN (&CASE_ID_VAR)
AND (FRT_TRANSACTION_TYPE IN ('B', 'S'))
GROUP BY CASE_ID,CLIENT_ID, account_Id
) CT, CLIENT C
WHERE  CT.CLIENT_ID = C.CLIENT_ID
AND total_count = excluded_count
AND ACCOUNT_ID IN (SELECT ACCOUNT_ID FROM ACCOUNT WHERE STATUS IN ('ACTIVE','APPROVAL'))
AND C.STATUS IN ('ACTIVE', 'APPROVAL')
ORDER BY C.SHORT_NAME
;
